import pandas as pd
from datetime import datetime

print("üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...")
df = pd.read_csv("combined_epl_results.csv")

# ----------------------------
# 1. –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ + Date
# ----------------------------
columns_to_keep = [
    # –î–∞—Ç–∞ –º–∞—Ç—á–∞
    'Date',

    # –ö–æ–º–∞–Ω–¥—ã
    'HomeTeam', 'AwayTeam',

    # –†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞
    'FTR',  # Full Time Result (H, D, A)

    # –ú–µ—Ç—Ä–∏–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Ç–∞–π–º–∞
    'HTHG', 'HTAG',  # –ì–æ–ª—ã
    'HS', 'AS',      # –£–¥–∞—Ä—ã
    'HST', 'AST',    # –£–¥–∞—Ä—ã –≤ —Å—Ç–≤–æ—Ä
    'HF', 'AF',      # –§–æ–ª—ã
    'HC', 'AC',      # –£–≥–ª–æ–≤—ã–µ
    'HY', 'AY',      # –ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    'HR', 'AR',      # –ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏

    # –ë—É–∫–º–µ–∫–µ—Ä—Å–∫–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ Bet365)
    'B365H', 'B365D', 'B365A'  # –ü–æ–±–µ–¥–∞ –¥–æ–º–∞—à–Ω–µ–π / –ù–∏—á—å—è / –ü–æ–±–µ–¥–∞ –≥–æ—Å—Ç–µ–π
]

# –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞—Ç–∞—Å–µ—Ç
df_filtered = df[columns_to_keep]

# ----------------------------
# 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É ‚Äî —É–∫–∞–∑—ã–≤–∞–µ–º —è–≤–Ω–æ —Ñ–æ—Ä–º–∞—Ç DD/MM/YYYY
# ----------------------------
print("\nüìÖ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–æ–ª–±–µ—Ü Date –≤ —Ñ–æ—Ä–º–∞—Ç datetime...")

# –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –∫–∞–∫ DD/MM/YYYY
df_filtered['Date'] = pd.to_datetime(df_filtered['Date'], format='%d/%m/%Y', errors='coerce')

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞—Ç—ã
invalid_dates = df_filtered[df_filtered['Date'].isna()]
if not invalid_dates.empty:
    print(f"\n‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ {len(invalid_dates)} —Å—Ç—Ä–æ–∫ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –¥–∞—Ç–æ–π.")
    print("üìâ –ü—Ä–∏–º–µ—Ä—ã:")
    print(invalid_dates[['Date', 'HomeTeam', 'AwayTeam']].head())

# ----------------------------
# 3. –£–¥–∞–ª—è–µ–º –º–∞—Ç—á–∏ –∏–∑ –±—É–¥—É—â–µ–≥–æ
# ----------------------------
now = pd.Timestamp(datetime.now())
future_matches = df_filtered[df_filtered['Date'] > now]
if not future_matches.empty:
    print(f"\n‚è≥ –ù–∞–π–¥–µ–Ω–æ {len(future_matches)} –º–∞—Ç—á–µ–π –∏–∑ –±—É–¥—É—â–µ–≥–æ.")
    print("üîÆ –ü—Ä–∏–º–µ—Ä—ã:")
    print(future_matches[['Date', 'HomeTeam', 'AwayTeam']].head())

df_filtered = df_filtered[df_filtered['Date'] <= now]

# ----------------------------
# 4. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ ‚Äî –≤–∞–∂–Ω–æ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
# ----------------------------
df_filtered.sort_values(by='Date', inplace=True)
df_filtered.reset_index(drop=True, inplace=True)

# ----------------------------
# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# ----------------------------
print("\n‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
print(f"üìä –†–∞–∑–º–µ—Ä –¥–∞—Ç–∞—Å–µ—Ç–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: {df_filtered.shape}")
print("\nüìÖ –ü–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏:")
print(df_filtered[['Date', 'HomeTeam', 'AwayTeam', 'FTR']].head(2))

# ----------------------------
# 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç
# ----------------------------
output_file = "processed_with_b365_data.csv"
df_filtered.to_csv(output_file, index=False)

print(f"\nüíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: {output_file}")